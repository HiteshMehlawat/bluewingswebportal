<div class="min-h-screen bg-gray-50 p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                {{ isClient ? 'My Service Requests' : (isStaff ? 'My Assigned Service Requests' : 'Service Request
                Management') }}
            </h1>
            <p class="text-gray-600">
                {{ isClient ? 'View and manage your service requests' : (isStaff ? 'View and manage your assigned
                service requests' : 'Manage and track all service requests across the organization') }}
            </p>
        </div>

        <!-- Statistics Cards (Admin Only) -->
        <div *ngIf="isAdmin && statistics" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                        <span class="material-icons text-2xl">assignment</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Requests</p>
                        <p class="text-2xl font-bold text-gray-900">{{ statistics.totalRequests || 0 }}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                        <span class="material-icons text-2xl">pending</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Pending</p>
                        <p class="text-2xl font-bold text-gray-900">{{ statistics.pendingRequests || 0 }}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100 text-green-600">
                        <span class="material-icons text-2xl">check_circle</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Completed</p>
                        <p class="text-2xl font-bold text-gray-900">{{ statistics.completedRequests || 0 }}</p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-red-100 text-red-600">
                        <span class="material-icons text-2xl">warning</span>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Overdue</p>
                        <p class="text-2xl font-bold text-gray-900">{{ statistics.overdueRequests || 0 }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="bg-white rounded-lg shadow mb-6 p-6">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center gap-4">
                    <!-- Client buttons -->
                    <ng-container *ngIf="isClient">
                        <button (click)="openAddModal()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                            <span class="material-icons text-base">add</span>
                            New Service Request
                        </button>
                    </ng-container>

                    <!-- Admin buttons -->
                    <ng-container *ngIf="isAdmin">
                        <button (click)="openAddModal()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                            <span class="material-icons text-base">add</span>
                            Add New Request
                        </button>
                    </ng-container>

                    <!-- Staff buttons -->
                    <ng-container *ngIf="isStaff">
                        <button (click)="openAddModal()"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors">
                            <span class="material-icons text-base">add</span>
                            Add New Request
                        </button>
                    </ng-container>
                </div>

                <!-- Search and Filters -->
                <div class="flex items-center gap-4">
                    <!-- Search -->
                    <div class="relative">
                        <input type="text" [(ngModel)]="searchTerm" (keyup.enter)="onSearch()"
                            placeholder="Search requests..."
                            class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <span class="material-icons absolute left-3 top-2.5 text-gray-400">search</span>
                    </div>

                    <!-- Status Filter -->
                    <select [(ngModel)]="statusFilter" (change)="onFilterChange()"
                        class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option *ngFor="let option of statusOptions" [value]="option.value">
                            {{ option.label }}
                        </option>
                    </select>

                    <!-- Priority Filter (Admin Only) -->
                    <select *ngIf="isAdmin" [(ngModel)]="priorityFilter" (change)="onFilterChange()"
                        class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option *ngFor="let option of priorityOptions" [value]="option.value">
                            {{ option.label }}
                        </option>
                    </select>

                    <!-- Search Button -->
                    <button (click)="onSearch()"
                        class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors">
                        Search
                    </button>
                </div>
            </div>
        </div>

        <!-- Service Requests Table -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Request ID
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Service
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Client
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Status
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Priority
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Deadline
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Assigned To
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr *ngFor="let request of serviceRequests" class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">{{ request.requestId }}</div>
                                <div class="text-sm text-gray-500">{{ request.createdAt | dateFormat:'medium' }}</div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-sm font-medium text-gray-900">{{ request.serviceItemName }}</div>
                                <div class="text-sm text-gray-500">{{ request.serviceCategoryName }} > {{
                                    request.serviceSubcategoryName }}</div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-sm font-medium text-gray-900">{{ request.clientName }}</div>
                                <div class="text-sm text-gray-500">{{ request.companyName }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span
                                    [class]="'inline-flex px-2 py-1 text-xs font-semibold rounded-full ' + getStatusBadgeClass(request.status || '')">
                                    {{ getStatusDisplayName(request.status || '') }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span
                                    [class]="'inline-flex px-2 py-1 text-xs font-semibold rounded-full ' + getPriorityBadgeClass(request.priority || '')">
                                    {{ getPriorityDisplayName(request.priority || '') }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">{{ request.preferredDeadline | dateFormat:'medium' }}
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">{{ request.assignedStaffName || 'Unassigned' }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="flex items-center gap-2">
                                    <!-- View Details - Always shown -->
                                    <button (click)="openDetailModal(request)" class="text-blue-600 hover:text-blue-900"
                                        title="View Details">
                                        <span class="material-icons text-base">visibility</span>
                                    </button>

                                    <!-- For rejected/cancelled services: only view button (admin gets view+delete) -->
                                    <ng-container
                                        *ngIf="!(request.status === 'REJECTED' || request.status === 'CANCELLED')">
                                        <!-- Edit (if allowed) -->
                                        <button *ngIf="canEdit(request) || isStaff" (click)="openEditModal(request)"
                                            class="text-green-600 hover:text-green-900" title="Edit Request">
                                            <span class="material-icons text-base">edit</span>
                                        </button>

                                        <!-- Assign (Admin only) -->
                                        <button *ngIf="canAssign(request)" (click)="openAssignModal(request)"
                                            class="text-purple-600 hover:text-purple-900" title="Assign to Staff">
                                            <span class="material-icons text-base">person_add</span>
                                        </button>



                                        <!-- Convert to Task (Admin/Staff) -->
                                        <button *ngIf="canConvertToTask(request) || isStaff"
                                            (click)="openConvertModal(request)"
                                            class="text-indigo-600 hover:text-indigo-900" title="Convert to Task">
                                            <span class="material-icons text-base">assignment</span>
                                        </button>

                                        <!-- Reject (Admin/Staff) -->
                                        <button *ngIf="canReject(request) || isStaff" (click)="openRejectModal(request)"
                                            class="text-orange-600 hover:text-orange-900" title="Reject Request">
                                            <span class="material-icons text-base">block</span>
                                        </button>

                                        <!-- Cancel (Client only for pending/assigned requests) -->
                                        <button *ngIf="canCancel(request)" (click)="cancelServiceRequest(request)"
                                            class="text-orange-600 hover:text-orange-900" title="Cancel Request">
                                            <span class="material-icons text-base">cancel</span>
                                        </button>
                                    </ng-container>

                                    <!-- Delete (Admin only for rejected/cancelled services) -->
                                    <button *ngIf="isAdmin " (click)="deleteServiceRequest(request)"
                                        class="text-red-600 hover:text-red-900" title="Delete Request">
                                        <span class="material-icons text-base">delete</span>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Loading State -->
            <div *ngIf="loading" class="p-8 text-center">
                <div class="inline-flex items-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <span class="ml-2 text-gray-600">Loading...</span>
                </div>
            </div>

            <!-- Empty State -->
            <div *ngIf="!loading && serviceRequests.length === 0" class="p-8 text-center">
                <div class="text-gray-500">
                    <span class="material-icons text-6xl mb-4">assignment</span>
                    <p class="text-lg font-medium">No service requests found</p>
                    <p class="text-sm">Get started by creating a new service request.</p>
                </div>
            </div>

            <!-- Error State -->
            <div *ngIf="error" class="p-4 bg-red-50 border border-red-200 rounded-lg">
                <div class="flex items-center">
                    <span class="material-icons text-red-600 mr-2">error</span>
                    <span class="text-red-800">{{ error }}</span>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        <app-pagination [page]="currentPage + 1" [pageSize]="pageSize" [total]="totalElements"
            [pageSizeOptions]="[5, 10, 20, 50]" (pageChange)="onPageChange($event)"
            (pageSizeChange)="onPageSizeChange($event)">
        </app-pagination>
    </div>
</div>

<!-- Add/Edit Modal -->
<div *ngIf="showAddModal || showEditModal"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-semibold">{{ showAddModal ? 'New Service Request' : 'Edit Service Request' }}</h2>
            <button (click)="closeModal()" class="text-gray-400 hover:text-gray-600">
                <span class="material-icons">close</span>
            </button>
        </div>

        <form [formGroup]="serviceRequestForm" (ngSubmit)="onSubmit()" class="space-y-6">
            <!-- Client Selection (Admin/Staff Only) -->
            <div *ngIf="!isClient">
                <label class="block text-sm font-medium text-gray-700 mb-2">Client *</label>
                <select formControlName="clientId"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">Select a client</option>
                    <option *ngFor="let client of availableClients" [value]="client.id">
                        {{ client.firstName }} {{ client.lastName }} - {{ client.companyName }}
                    </option>
                </select>
                <div *ngIf="serviceRequestForm.get('clientId')?.invalid && serviceRequestForm.get('clientId')?.touched"
                    class="text-red-500 text-sm mt-1">
                    Client selection is required
                </div>
            </div>

            <!-- Service Selection -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Service Required</label>
                <app-service-selection formControlName="serviceItemId" [showServiceDescription]="false"
                    [disabled]="isClient && showEditModal" (serviceSelected)="onServiceSelected($event)">
                </app-service-selection>
                <div *ngIf="serviceRequestForm.get('serviceItemId')?.invalid && serviceRequestForm.get('serviceItemId')?.touched"
                    class="text-red-500 text-sm mt-1">
                    Service selection is required
                </div>
                <div *ngIf="isClient && showEditModal" class="text-xs text-gray-500 mt-1">
                    <span class="material-icons text-xs align-text-bottom mr-1">lock</span>
                    Read-only (Service cannot be changed after creation)
                </div>
            </div>

            <!-- Description -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Description *</label>
                <textarea formControlName="description" rows="3"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Describe your service requirement..."></textarea>
                <div *ngIf="isClient && showEditModal" class="text-xs text-green-600 mt-1">
                    <span class="material-icons text-xs align-text-bottom mr-1">edit</span>
                    Editable (Client can update)
                </div>
            </div>

            <!-- Notes -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Additional Notes</label>
                <textarea formControlName="notes" rows="2"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Any additional notes..."></textarea>
                <div *ngIf="isClient && showEditModal" class="text-xs text-green-600 mt-1">
                    <span class="material-icons text-xs align-text-bottom mr-1">edit</span>
                    Editable (Client can update)
                </div>
            </div>

            <!-- Preferred Deadline -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Preferred Deadline *</label>
                <input type="date" formControlName="preferredDeadline"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <div *ngIf="isClient && showEditModal" class="text-xs text-green-600 mt-1">
                    <span class="material-icons text-xs align-text-bottom mr-1">edit</span>
                    Editable (Client can update)
                </div>
            </div>

            <!-- Priority -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                <select formControlName="priority"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="LOW">Low</option>
                    <option value="MEDIUM">Medium</option>
                    <option value="HIGH">High</option>
                    <option value="URGENT">Urgent</option>
                </select>
                <div *ngIf="isClient && showEditModal" class="text-xs text-green-600 mt-1">
                    <span class="material-icons text-xs align-text-bottom mr-1">edit</span>
                    Editable (Client can update)
                </div>
            </div>

            <!-- Status Selection (Admin/Staff) -->
            <div *ngIf="isAdmin || isStaff">
                <label class="block text-sm font-medium text-gray-700 mb-2">Status *</label>
                <select formControlName="status" (change)="onStatusChangeFromForm($event)"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option *ngFor="let status of statusOptionsForForm" [value]="status.value">
                        {{ status.label }}
                    </option>
                </select>
                <div *ngIf="serviceRequestForm.get('status')?.invalid && serviceRequestForm.get('status')?.touched"
                    class="text-red-500 text-sm mt-1">
                    Status is required
                </div>
            </div>

            <!-- Staff Assignment (Admin/Staff) -->
            <div *ngIf="isAdmin">
                <label class="block text-sm font-medium text-gray-700 mb-2">Assign Staff</label>
                <select formControlName="assignedStaffId"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    [disabled]="loadingStaff">
                    <option value="">
                        {{ loadingStaff ? 'Loading staff...' : 'Select staff member' }}
                    </option>
                    <option *ngFor="let staff of availableStaff" [value]="staff.id">
                        {{ staff.firstName }} {{ staff.lastName }} - {{ staff.email }}
                    </option>
                </select>
                <div *ngIf="loadingStaff" class="text-xs text-gray-500 mt-1">
                    <span class="material-icons text-xs align-text-bottom mr-1">hourglass_empty</span>
                    Loading available staff members...
                </div>
            </div>

            <!-- Admin/Staff Additional Fields -->
            <div *ngIf="!isClient" class="space-y-4">
                <!-- Admin Notes (Admin) -->
                <div *ngIf="isAdmin">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Admin Notes</label>
                    <textarea formControlName="adminNotes" rows="2"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Internal notes for admin..."></textarea>
                </div>

                <!-- Staff Notes (Staff Only) -->
                <div *ngIf="isStaff">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Staff Notes</label>
                    <textarea formControlName="staffNotes" rows="2"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Internal notes for staff..."></textarea>
                </div>

                <!-- Estimated Price (Admin/Staff) -->
                <div *ngIf="isAdmin || isStaff">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Estimated Price (₹)</label>
                    <input type="number" formControlName="estimatedPrice" step="0.01" min="0"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="0.00">
                </div>

                <!-- Final Price (Admin/Staff) -->
                <div *ngIf="isAdmin || isStaff">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Final Price (₹)</label>
                    <input type="number" formControlName="finalPrice" step="0.01" min="0"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="0.00">
                </div>
            </div>

            <!-- Form Actions -->
            <div class="flex items-center justify-end gap-4 pt-6 border-t">
                <button type="button" (click)="closeModal()"
                    class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                    Cancel
                </button>
                <button type="submit" [disabled]="!serviceRequestForm.valid"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    {{ showAddModal ? 'Create Request' : 'Update Request' }}
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Service Request Detail Modal -->
<div *ngIf="showDetailModal && selectedServiceRequest"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <!-- Header -->
        <div class="flex items-center justify-between p-6 border-b">
            <h2 class="text-xl font-semibold text-gray-800">Service Request Details</h2>
            <button (click)="closeModal()" class="text-gray-400 hover:text-gray-600">
                <span class="material-icons text-2xl">close</span>
            </button>
        </div>

        <!-- Content -->
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Request Information -->
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-blue-700 border-b pb-2">Request Information</h3>
                    <div class="space-y-3">
                        <div><span class="font-semibold">Request ID:</span> {{ selectedServiceRequest.requestId }}</div>
                        <div><span class="font-semibold">Service:</span> {{ selectedServiceRequest.serviceItemName ||
                            'Not specified' }}</div>
                        <div><span class="font-semibold">Service Category:</span> {{
                            selectedServiceRequest.serviceCategoryName || 'Not specified' }}</div>
                        <div><span class="font-semibold">Service Subcategory:</span> {{
                            selectedServiceRequest.serviceSubcategoryName || 'Not specified' }}</div>
                        <div><span class="font-semibold">Description:</span> {{ selectedServiceRequest.description }}
                        </div>
                        <div><span class="font-semibold">Notes:</span> {{ selectedServiceRequest.notes || 'No notes' }}
                        </div>
                    </div>
                </div>

                <!-- Status and Priority Information -->
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-green-700 border-b pb-2">Status & Priority</h3>
                    <div class="space-y-3">
                        <div><span class="font-semibold">Status:</span>
                            <span
                                class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full {{ getStatusBadgeClass(selectedServiceRequest.status || '') }}">
                                {{ getStatusDisplayName(selectedServiceRequest.status || '') }}
                            </span>
                        </div>
                        <div><span class="font-semibold">Priority:</span>
                            <span
                                class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full {{ getPriorityBadgeClass(selectedServiceRequest.priority || '') }}">
                                {{ getPriorityDisplayName(selectedServiceRequest.priority || '') }}
                            </span>
                        </div>
                        <div><span class="font-semibold">Preferred Deadline:</span> {{
                            selectedServiceRequest.preferredDeadline | dateFormat:'medium' }}</div>
                    </div>
                </div>

                <!-- Assignment Information -->
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-red-700 border-b pb-2">Assignment Information</h3>
                    <div class="space-y-3">
                        <div><span class="font-semibold">Client:</span> {{ selectedServiceRequest.clientName }}</div>
                        <div><span class="font-semibold">Client ID:</span> {{ selectedServiceRequest.clientId }}</div>
                        <div><span class="font-semibold">Assigned To:</span> {{ selectedServiceRequest.assignedStaffName
                            || 'Unassigned' }}</div>
                        <div *ngIf="selectedServiceRequest.assignedStaffEmail"><span class="font-semibold">Staff
                                Email:</span> {{ selectedServiceRequest.assignedStaffEmail }}</div>
                    </div>
                </div>

                <!-- Timeline Information -->
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-green-700 border-b pb-2">Timeline</h3>
                    <div class="space-y-3">
                        <div><span class="font-semibold">Created Date:</span> {{ selectedServiceRequest.createdAt |
                            dateFormat:'medium' }}</div>
                        <div *ngIf="selectedServiceRequest.assignedDate"><span class="font-semibold">Assigned
                                Date:</span> {{ selectedServiceRequest.assignedDate | dateFormat:'medium' }}</div>
                        <div *ngIf="selectedServiceRequest.completedDate"><span class="font-semibold">Completed
                                Date:</span> {{ selectedServiceRequest.completedDate | dateFormat:'medium' }}</div>
                        <div *ngIf="selectedServiceRequest.rejectedDate"><span class="font-semibold">Rejected
                                Date:</span> {{ selectedServiceRequest.rejectedDate | dateFormat:'medium' }}</div>
                        <div><span class="font-semibold">Last Updated:</span> {{ selectedServiceRequest.updatedAt |
                            dateFormat:'medium' }}</div>
                    </div>
                </div>

                <!-- Additional Information -->
                <div class="space-y-4" *ngIf="!isClient">
                    <h3 class="text-lg font-medium text-purple-700 border-b pb-2">Additional Information</h3>
                    <div class="space-y-3">
                        <div *ngIf="selectedServiceRequest.adminNotes"><span class="font-semibold">Admin Notes:</span>
                            {{ selectedServiceRequest.adminNotes }}</div>
                        <div *ngIf="selectedServiceRequest.staffNotes"><span class="font-semibold">Staff Notes:</span>
                            {{ selectedServiceRequest.staffNotes }}</div>
                        <div *ngIf="selectedServiceRequest.rejectionReason"><span class="font-semibold">Rejection
                                Reason:</span> {{ selectedServiceRequest.rejectionReason }}</div>
                    </div>
                </div>

                <!-- Pricing Information -->
                <div class="space-y-4">
                    <h3 class="text-lg font-medium text-yellow-700 border-b pb-2">Pricing Information</h3>
                    <div class="space-y-3">
                        <!-- Show Estimated Price only to admin/staff -->
                        <div *ngIf="!isClient && selectedServiceRequest.estimatedPrice"><span
                                class="font-semibold">Estimated
                                Price:</span> ₹{{ selectedServiceRequest.estimatedPrice | number:'1.2-2' }}</div>
                        <!-- Final Price is visible to everyone -->
                        <div *ngIf="selectedServiceRequest.finalPrice"><span class="font-semibold">Final Price:</span>
                            ₹{{ selectedServiceRequest.finalPrice | number:'1.2-2' }}</div>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end gap-4 mt-8 pt-6 border-t">
                <button (click)="closeModal()"
                    class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Dialog -->
<app-confirm-dialog *ngIf="showDeleteDialog && serviceRequestToDelete" title="Delete Service Request"
    [message]="'Are you sure you want to delete the service request ' + serviceRequestToDelete.requestId + '? This action cannot be undone.'"
    confirmLabel="Delete" cancelLabel="Cancel" (confirm)="confirmDelete()" (cancel)="cancelDelete()">
</app-confirm-dialog>

<!-- Cancel Confirmation Dialog -->
<app-confirm-dialog *ngIf="showCancelDialog && serviceRequestToCancel" title="Cancel Service Request"
    [message]="'Are you sure you want to cancel the service request ' + serviceRequestToCancel.requestId + '? This action cannot be undone.'"
    confirmLabel="Cancel Request" cancelLabel="Keep Request" (confirm)="confirmCancel()"
    (cancel)="cancelCancelDialog()">
</app-confirm-dialog>

<!-- Assign Service Request Modal -->
<div *ngIf="showAssignModal && selectedServiceRequest"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full">
        <!-- Header -->
        <div class="flex items-center justify-between p-6 border-b">
            <h2 class="text-xl font-semibold text-gray-800">Assign Service Request</h2>
            <button (click)="closeModal()" class="text-gray-400 hover:text-gray-600">
                <span class="material-icons text-2xl">close</span>
            </button>
        </div>

        <!-- Content -->
        <div class="p-6">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Service Request</label>
                <div class="text-gray-900 font-medium">{{ selectedServiceRequest?.serviceItemName }}</div>
                <div class="text-sm text-gray-500">{{ selectedServiceRequest?.description }}</div>
                <div class="text-xs text-gray-400 mt-1">
                    Currently assigned to: {{ selectedServiceRequest?.assignedStaffName || 'Unassigned' }}
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Staff Member *</label>
                <select #staffSelect
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    [disabled]="loadingStaff">
                    <option value="">
                        {{ loadingStaff ? 'Loading staff...' : 'Select Staff Member' }}
                    </option>
                    <option *ngFor="let staff of availableStaff" [value]="staff.id">
                        {{ staff.firstName }} {{ staff.lastName }} - {{ staff.email }}
                    </option>
                </select>
                <p class="text-xs text-gray-500 mt-1">Select the staff member to assign this service request to</p>
                <div *ngIf="loadingStaff" class="text-xs text-gray-500 mt-1">
                    <span class="material-icons text-xs align-text-bottom mr-1">hourglass_empty</span>
                    Loading available staff members...
                </div>
                <div *ngIf="staffError" class="text-xs text-red-500 mt-1">
                    <span class="material-icons text-xs align-text-bottom mr-1">error</span>
                    {{ staffError }}
                    <button (click)="loadAvailableStaff()" class="ml-2 text-blue-600 hover:text-blue-800 underline">
                        Retry
                    </button>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Admin Notes</label>
                <textarea #adminNotes rows="3"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Any notes or instructions for the staff member..."></textarea>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end gap-4">
                <button (click)="closeModal()"
                    class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    Cancel
                </button>
                <button (click)="onAssign(+staffSelect.value, adminNotes.value)" [disabled]="!staffSelect.value"
                    class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    Assign Request
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Reject Service Request Modal -->
<div *ngIf="showRejectModal && selectedServiceRequest"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full">
        <!-- Header -->
        <div class="flex items-center justify-between p-6 border-b">
            <h2 class="text-xl font-semibold text-gray-800">Reject Service Request</h2>
            <button (click)="closeModal()" class="text-gray-400 hover:text-gray-600">
                <span class="material-icons text-2xl">close</span>
            </button>
        </div>

        <!-- Content -->
        <div class="p-6">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Service Request</label>
                <div class="text-gray-900 font-medium">{{ selectedServiceRequest?.serviceItemName }}</div>
                <div class="text-sm text-gray-500">{{ selectedServiceRequest?.description }}</div>
                <div class="text-xs text-gray-400 mt-1">
                    Request ID: {{ selectedServiceRequest?.requestId }}
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Rejection Reason *</label>
                <textarea #rejectionReason rows="3"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Please provide a reason for rejection..."></textarea>
                <p class="text-xs text-gray-500 mt-1">This reason will be communicated to the client</p>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end gap-4">
                <button (click)="closeModal()"
                    class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    Cancel
                </button>
                <button (click)="onReject(rejectionReason.value)" [disabled]="!rejectionReason.value.trim()"
                    class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    Reject Request
                </button>
            </div>
        </div>
    </div>
</div>



<!-- Convert to Task Modal -->
<div *ngIf="showConvertModal && selectedServiceRequest"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-2xl w-full">
        <!-- Header -->
        <div class="flex items-center justify-between p-6 border-b">
            <h2 class="text-xl font-semibold text-gray-800">Convert Service Request to Task</h2>
            <button (click)="closeModal()" class="text-gray-400 hover:text-gray-600">
                <span class="material-icons text-2xl">close</span>
            </button>
        </div>

        <!-- Content -->
        <div class="p-6">
            <!-- Auto-population info -->
            <!--  <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <span class="material-icons text-blue-600 mr-2">info</span>
                        <p class="text-sm text-blue-800">
                            <strong>Auto-population:</strong> Task fields are automatically populated from the service
                            request data.
                            You can modify any field as needed before converting to task.
                        </p>
                    </div>
                    <button (click)="manualTriggerAutoPopulate()"
                        class="px-3 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700">
                        Re-populate Fields
                    </button>
                </div>
            </div> -->

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Left Column -->
                <div class="space-y-4">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Service Request Details</label>
                        <div class="text-gray-900 font-medium">{{ selectedServiceRequest?.serviceItemName }}</div>
                        <div class="text-sm text-gray-500">{{ selectedServiceRequest?.description }}</div>
                        <div class="text-xs text-gray-400 mt-1">
                            Request ID: {{ selectedServiceRequest?.requestId }}
                        </div>
                        <div class="text-xs text-gray-400">
                            Client: {{ selectedServiceRequest?.clientName }}
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Task Title *</label>
                        <input type="text" #taskTitle id="taskTitle"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="Enter task title...">
                        <p class="text-xs text-gray-500 mt-1">Auto-populated from service request. You can modify as
                            needed.</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Task Description *</label>
                        <textarea #taskDescription id="taskDescription" rows="3"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="Enter task description..."></textarea>
                        <p class="text-xs text-gray-500 mt-1">Auto-populated from service request. You can modify as
                            needed.</p>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                        <select #taskPriority id="taskPriority"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="LOW">Low</option>
                            <option value="MEDIUM" selected>Medium</option>
                            <option value="HIGH">High</option>
                            <option value="URGENT">Urgent</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Auto-populated from service request priority. You can
                            modify as needed.</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Due Date</label>
                        <input type="date" #taskDueDate id="taskDueDate"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <p class="text-xs text-gray-500 mt-1">Auto-populated from preferred deadline. You can modify as
                            needed.</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Estimated Hours</label>
                        <input type="number" #taskEstimatedHours id="taskEstimatedHours" min="0" step="0.5"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="0.0">
                        <p class="text-xs text-gray-500 mt-1">Auto-populated from service item. You can modify as
                            needed.</p>
                    </div>

                    <div *ngIf="isAdmin">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Assign Staff</label>
                        <select #taskAssignedStaff id="taskAssignedStaff"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Select staff member</option>
                            <option *ngFor="let staff of availableStaff" [value]="staff.id">
                                {{ staff.firstName }} {{ staff.lastName }} - {{ staff.email }}
                            </option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Select staff to assign this task to</p>
                    </div>

                    <div *ngIf="isStaff">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Assigned Staff</label>
                        <div class="px-3 py-2 bg-gray-100 rounded-lg text-gray-700">
                            {{ getCurrentStaffName() }}
                        </div>
                        <p class="text-xs text-gray-500 mt-1">You will be automatically assigned to this task</p>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end gap-4 pt-6 border-t">
                <button (click)="closeModal()"
                    class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    Cancel
                </button>
                <button (click)="convertToTask()" [disabled]="!taskTitle.value.trim() || !taskDescription.value.trim()"
                    class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed">
                    Convert to Task
                </button>
            </div>
        </div>
    </div>
</div>